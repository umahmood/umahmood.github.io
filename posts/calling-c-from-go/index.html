<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb" lang="en-gb">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.d451ff92e80abc2a828eb9bb262e4db374bd4e954642f9245c54eec84bf690f3.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Usman Mahmood - Calling C from Go</title>
<meta property="og:title" content=Usman&#32;Mahmood&#32;-&#32;Calling&#32;C&#32;from&#32;Go />
<meta name="twitter:title" content=Usman&#32;Mahmood&#32;-&#32;Calling&#32;C&#32;from&#32;Go />
<meta itemprop="name" content=Usman&#32;Mahmood&#32;-&#32;Calling&#32;C&#32;from&#32;Go />
<meta name="application-name" content=Usman&#32;Mahmood&#32;-&#32;Calling&#32;C&#32;from&#32;Go />
<meta property="og:site_name" content="Blog" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://www.usman.me.uk/posts/calling-c-from-go/" />
<link rel="canonical" href="https://www.usman.me.uk/posts/calling-c-from-go/" itemprop="url" />
<meta name="url" content="https://www.usman.me.uk/posts/calling-c-from-go/" />
<meta name="twitter:url" content="https://www.usman.me.uk/posts/calling-c-from-go/" />
<meta property="og:url" content="https://www.usman.me.uk/posts/calling-c-from-go/" />


<meta property="og:updated_time" content="2015-07-25T20:18:15&#43;01:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://www.usman.me.uk/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@make_slice" />
    <meta name="twitter:creator" content="@make_slice" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.152.2">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.c1a1f3f468f1f8e5729d2e79b1812f536a2ba0be45fab2fde2a56f4614a55c86.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://www.usman.me.uk/">
                <img src="/images/gopher.png" alt="brand image">
            </a>
        
        
            <a href="https://www.usman.me.uk/">
                <h1>Usman Mahmood</h1>
            </a>
        
    </h1>
    <p class="lead">
    Algorithms + Data Structures = Programs
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
            
            
                
                
            
                
                
            
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                
            
            
                
                
            
                
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/umahmood">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>





    <a target="_blank" class="social" title="X" href="https://x.com/make_slice">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 512 472.799">
            <path fill="currentColor" d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z"/>
        </svg>
    </a>

















        <p class="footnote">
    <br>
    &copy; 2025 Usman Mahmood. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://www.usman.me.uk/posts/calling-c-from-go/">Calling C from Go</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2015-07-25T20:18:15&#43;0100" class="post-date">
        July 25, 2015
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>4 mins read</span>
      </span>
    </div>

    
  </div>

  
  

  
</div>

  <p>This post will show you the basics of how to call C code from a Go package.</p>
<p>Lets get started with an example:</p>
<p>Create a header file &ldquo;add.h&rdquo; with a function prototype:</p>
<pre><code>#ifndef _ADD_H_
#define _ADD_H_
int add(int, int);
#endif
</code></pre>
<p>Create the source file &ldquo;add.c&rdquo; containing the definition for add:</p>
<pre><code>#include &quot;add.h&quot;

int add(int a, int b)
{
   return a + b;
}
</code></pre>
<p>Create a Go package &ldquo;main.go&rdquo;:</p>
<pre><code>package main

// #include &quot;add.c&quot;
import &quot;C&quot;

import (
    &quot;fmt&quot;
)

func main() {
    r := C.add(40, 2)
    fmt.Println(&quot;result = &quot;, r)
}
</code></pre>
<p>Ouptut:</p>
<pre><code>$ go build main.go
$ ./main
result = 42
</code></pre>
<p>Notice the comment above the import &ldquo;C&rdquo; statement we include add.c not add.h.</p>
<p>If import &ldquo;C&rdquo; is immediately preceded by comments, then those comments become apart of the compilation process. If there are any spaces between the comments, then those are seen as normal go comments, for example:</p>
<pre><code>// #include &lt;math.h&gt;

// #include &lt;stdio.h&gt;
// #include &lt;errno.h&gt;
import &quot;C&quot;
</code></pre>
<p>The header files stdio.h and errno.h are included as part of the compilation process, math.h is <strong>not</strong>.</p>
<h2 id="inline-c">Inline C</h2>
<p>You can also write C code directly in the comments, here is an example:</p>
<pre><code>package main

/*
int fortytwo()
{
    return 42;
}
*/
import &quot;C&quot;

import (
    &quot;fmt&quot;
)

func main() {
    fmt.Println(C.fortytwo)     // address
    fmt.Println(C.fortytwo())   // invocation
}
</code></pre>
<p>Output:</p>
<pre><code>$ go build inline.go
$ ./inline
0x40014a0
42
</code></pre>
<h2 id="accessing-c-structs">Accessing C structs</h2>
<p>Assume we have the below C struct defined in a .h or .c file:</p>
<pre><code>struct point {
    int x;
    int y;
};
</code></pre>
<p>In order to access this from a Go package, you simple prefix the type name &ldquo;point&rdquo; with &ldquo;C.struct_&rdquo;:</p>
<pre><code>func main() {
    p := C.struct_point{}
    p.x = 99
    p.y = 42
    fmt.Printf(&quot;type:   %T\n&quot;, p)
    fmt.Printf(&quot;struct: %+v\n&quot;, p)
}
</code></pre>
<p>Output:</p>
<pre><code>$ go build cstruct.go
$ ./cstruct
type:   main._Ctype_struct_point
struct: {x:99 y:42}
</code></pre>
<h2 id="controlling-the-behaviour-of-the-c-compiler">Controlling the behaviour of the C compiler</h2>
<p>You can pass flags to the C compiler to control its behaviour. This is done by defining a CFLAGS with a pseudo #cgo directive in the comments. In the example below, the -H flag will be passed to the C compiler (clang in my case) when it&rsquo;s invoked. The -H flag tells clang to show the header includes and nesting depth.</p>
<pre><code>package main

// #cgo CFLAGS: -H
// #include &quot;add.c&quot;
import &quot;C&quot;

import (
    &quot;fmt&quot;
)

func main() {
    r := C.add(40, 2)
    fmt.Println(&quot;result = &quot;, r)
}
</code></pre>
<p>Ouptut:</p>
<pre><code>$ go build main.go
!! this output is from clang writing to stdout because we passed the -H flag !!
. ./add.c
.. ./add.h
. /usr/include/errno.h
.. /usr/include/sys/errno.h
... /usr/include/sys/cdefs.h
.... /usr/include/sys/_symbol_aliasing.h
.... /usr/include/sys/_posix_availability.h
...

$ ./main
result = 42
</code></pre>
<h2 id="peeking-behind-the-scenes">Peeking behind the scenes</h2>
<p>What is happening when we build a Go package that includes an import &ldquo;C&rdquo; statement.</p>
<p>Firstly import &ldquo;C&rdquo; is a pseudo-package it is not listed in the standard library. When the go compiler sees the pseudo-package import &ldquo;C&rdquo; it runs the <strong>cgo</strong> command, this generates all the supporting infrastructure. It transforms main.go outputting some .h and .c files, these are then passed to clang to compile.</p>
<p><strong>Note:</strong> the cgo command actually invokes the gcc compiler, however on my machine gcc is an alias for clang, so it&rsquo;s clang that is doing the compiling.</p>
<p>The output from the C compiler is an object file named _cgo_.o, which contains the compiled C code. This object code (_cgo_.o) is then linked into the rest of the go binary.</p>
<p>Lets runs the cgo command directly to get a better understanding:</p>
<pre><code>$ go tool cgo main.go
</code></pre>
<p>This command will output a directory called _obj:</p>
<pre><code>$ ls _obj/

_cgo_.o
_cgo_defun.c
_cgo_export.c
_cgo_export.h
_cgo_flags
_cgo_gotypes.go
_cgo_main.c
main.cgo1.go
main.cgo2.c
</code></pre>
<p>As stated _cgo_.o contains the compiled C code, one interesting file to browse is main.cgo2.c:</p>
<pre><code>$ cat main.cgo2.c

#line 10 &quot;/go/src/samples/main.go&quot;

 #include &quot;add.c&quot;

// Usual nonsense: if x and y are not equal, the type will be invalid
// (have a negative array count) and an inscrutable error will come
// out of the compiler and hopefully mention &quot;name&quot;.
#define __cgo_compile_assert_eq(x, y, name) typedef char name[(x-y)*(x-y)*-2+1];

// Check at compile time that the sizes we use match our expectations.
#define __cgo_size_assert(t, n) __cgo_compile_assert_eq(sizeof(t), n, _cgo_sizeof_##t##_is_not_##n)

__cgo_size_assert(char, 1)
__cgo_size_assert(short, 2)
__cgo_size_assert(int, 4)
typedef long long __cgo_long_long;
__cgo_size_assert(__cgo_long_long, 8)
__cgo_size_assert(float, 4)
__cgo_size_assert(double, 8)

extern char* _cgo_topofstack(void);

#include &lt;errno.h&gt;
#include &lt;string.h&gt;

void
_cgo_7474d4d504ba_Cfunc_add(void *v)
{
    struct {
        int p0;
        int p1;
        int r;
        char __pad12[4];
    } __attribute__((__packed__)) *a = v;
    char *stktop = _cgo_topofstack();
    __typeof__(a-&gt;r) r = add(a-&gt;p0, a-&gt;p1);
    a = (void*)((char*)a + (_cgo_topofstack() - stktop));
    a-&gt;r = r;
}
</code></pre>
<p>Take a while to browse the other files, they are quite interesting.</p>
<p>I hope you enjoyed this post.</p>
<p><strong>Note:</strong> I am on OSX 10.10.4 64 bit using go version 1.4.2 and clang version 602.0.53.</p>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://www.usman.me.uk/posts/first/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>First Post</a>
        
	    
            <div class="next-post">
                <a href="https://www.usman.me.uk/posts/go-string-concat/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Go and String Concatenation</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  

        </div>
    </body>
</html>
